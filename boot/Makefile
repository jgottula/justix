# justix: boot
# (c) 2013 Justin Gottula
# The source code of this project is distributed under the terms of the
# simplified BSD license. See the LICENSE file for details.

AS:=nasm
ASFLAGS:=-fbin -MP -Ox -Wall


.PHONY: all clean mbr stage1 stage2

# default rule
all: mbr stage1 stage2

mbr:    out/bin/mbr    out/hex/mbr
stage1: out/bin/stage1 out/hex/stage1
stage2: out/bin/stage2 out/hex/stage2

clean:
	rm -rf $(wildcard out/*/*) $(wildcard src/*/*.dep)


out/hex/%: out/bin/% Makefile
	xxd -a out/bin/$* $@

out/bin/%: Makefile
	$(AS) $(ASFLAGS) -dMAPFILE=out/map/$* -o $@ -isrc/ -isrc/$*/ -lout/lst/$* -MD src/$*/$*.dep src/$*/$*.s
	grep $*_fill out/map/$*


# concatenate nasm's autogenerated dependencies
-include src/*/*.dep
