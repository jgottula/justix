# jgsys: kern
# (c) 2013 Justin Gottula
# The source code of this project is distributed under the terms of the
# simplified BSD license. See the LICENSE file for details.

PREFIX:=/usr/lib/cross-i586-elf/i586-elf/bin

AS:=nasm
CC:=ccache i586-elf-gcc

LD     :=$(PREFIX)/ld
OBJCOPY:=$(PREFIX)/objcopy
OBJDUMP:=$(PREFIX)/objdump
NM     :=$(PREFIX)/nm


ASFLAGS:=-felf -MP -Ox -Wall
CPPFLAGS:=-std=gnu11 -Wall -x assembler-with-cpp -D__ASSEMBLY__
CFLAGS:=-std=gnu11 -O2 -ggdb -Wall -Wextra -ffreestanding -fno-omit-frame-pointer -nodefaultlibs -nostdlib -march=pentium-mmx -mtune=pentium-mmx
LDFLAGS:=-Tkern.ld


SOURCE_S:=$(shell find src -type f -iname '*.s')
SOURCE_C:=$(shell find src -type f -iname '*.c')
SOURCE_ALL:=$(SOURCE_S) $(SOURCE_C)

OBJ_S:=$(patsubst %.s,%.o,$(SOURCE_S))
OBJ_C:=$(patsubst %.c,%.o,$(SOURCE_C))
OBJ_ALL:=$(OBJ_S) $(OBJ_C)


.PHONY: all clean kern

# default rule
all: kern

kern: out/kern.bin out/kern.elf out/kern.map out/kern.dump

clean:
	rm -rf $(wildcard out/*) $(shell find src -type f \( -iname '*.dep' -or -iname '*.o' \) )


out/kern.dump: out/kern.elf Makefile
	$(OBJDUMP) -aCdfhlpS -M intel-mnemonic,i386 $< >$@

out/kern.map: out/kern.elf Makefile
	$(NM) -ACnS $< >$@

out/kern.bin: out/kern.elf kern.ld Makefile
	$(OBJCOPY) -S -O binary $< $@

out/kern.elf: $(OBJ_ALL) Makefile
	$(LD) $(LDFLAGS) -o $@ $(OBJ_ALL)


$(OBJ_C): %.o: %.c Makefile
	$(CC) $(CFLAGS) -o $@ -Isrc/ -MP -MMD -MF $(<D)/$(patsubst %.c,%.dep,$(<F)) -c $<

$(OBJ_S): %.o: %.s Makefile
	$(AS) $(ASFLAGS) -o $@ -isrc/ -MD $(<D)/$(patsubst %.s,%.dep,$(<F)) $<


# concatenate nasm/gcc's autogenerated dependencies
-include src/*/*.dep
