# jgsys: kern
# (c) 2013 Justin Gottula
# The source code of this project is distributed under the terms of the
# simplified BSD license. See the LICENSE file for details.

PREFIX:=/usr/lib/cross-i586-elf/i586-elf/bin

AS:=nasm
CC:=ccache i586-elf-gcc

LD     :=$(PREFIX)/ld
OBJCOPY:=$(PREFIX)/objcopy
OBJDUMP:=$(PREFIX)/objdump
NM     :=$(PREFIX)/nm


ASFLAGS:=-felf -MP -Ox -Wall
CPPFLAGS:=-std=gnu11 -Wall -x assembler-with-cpp -D__ASSEMBLY__
CFLAGS:=-std=gnu11 -O1 -ggdb -Wall -Wextra -Wno-unused-variable -ffreestanding -fno-omit-frame-pointer -fno-strict-aliasing -fpack-struct -nodefaultlibs -nostdlib -march=pentium-mmx -mtune=pentium-mmx -include stdbool.h -include stdint.h -include common/macros.h
LDFLAGS:=-Tkern.ld


HEADERS:=$(shell find . -type f -name '*.h')
HEADERS_C_ONLY:=./src/common/version.h ./src/common/inline.h ./src/common/port.h
HEADERS_INC:=$(patsubst %.h,%.inc,$(filter-out $(HEADERS_C_ONLY),$(HEADERS)))

SOURCE_S:=$(shell find . -type f -name '*.s')
SOURCE_C:=$(shell find . -type f -name '*.c')
SOURCE_ALL:=$(SOURCE_S) $(SOURCE_C)

OBJ_S:=$(patsubst %.s,%.s.o,$(SOURCE_S))
OBJ_C:=$(patsubst %.c,%.c.o,$(SOURCE_C))
OBJ_ALL:=$(OBJ_S) $(OBJ_C)

CLEAN:=$(wildcard out/*) $(shell find src -type f \( -iname '*.dep' -or -iname '*.o' -or -iname '*.inc' -or -iname '*.lst' \) )


.PHONY: all clean kern

# always update version.h when building
.PHONY: src/common/version.h

# default rule
all: kern

kern: out/kern.bin out/kern.elf out/kern.debug out/kern.map out/kern.dump

clean:
	rm -rf $(CLEAN)


out/kern.dump: out/kern.elf Makefile
	$(OBJDUMP) -aCdfhpS -M intel-mnemonic,i386 $< >$@

out/kern.map: out/kern.elf Makefile
	$(NM) -Cn $< >$@

out/kern.debug: out/kern.elf Makefile
	$(OBJCOPY) -S -O binary $< $@

out/kern.bin: out/kern.elf kern.ld Makefile
	$(OBJCOPY) --only-keep-debug $< $@

out/kern.elf: $(OBJ_ALL) kern.ld Makefile
	$(LD) $(LDFLAGS) -Map=out/kern.ldmap -o $@ $(OBJ_ALL)


$(OBJ_C): %.c.o: %.c Makefile
	$(CC) $(CFLAGS) -o $@ -Isrc/ -MP -MMD -MF $(<:%.c=%.c.dep) -c $<
	$(OBJDUMP) -CdS -M intel-mneumonic,i386 $@ >$(<:%.c=%.c.lst)

$(OBJ_S): %.s.o: %.s $(HEADERS_INC) Makefile
	$(AS) $(ASFLAGS) -o $@ -isrc/ -D$(subst src,jgsys_kern,$(subst /,_,$(<:.s=))) -l$(<:%.s=%.s.lst) -MD $(<:%.s=%.s.dep) $<

$(HEADERS_INC): %.inc: %.h Makefile
	$(CC) $(CPPFLAGS) -E -o $@ $<


# concatenate nasm/gcc's autogenerated dependencies
-include src/*/*.dep
